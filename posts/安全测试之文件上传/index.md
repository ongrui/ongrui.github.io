# 安全测试之-文件上传





## 文件上传漏洞

当文件上传点未对上传的文件进行严格的验证和过滤时，就容易造成任意文件上传，比如webshell文件

如果文件上传的目录没有限制执行权限，导致上传的动态文件可以正常执行并且访问，即造成了文件上传漏洞

## 什么是webshell

webshell简称网页后门，运行在web应用上的远程控制程序

其实就是一个网页，由PHP、jsp、asp、asp.net等之类的web应用程序语言开发，但是webshell并不具备常见网页的功能，例如登录、注册、信息展示功能，一般会具备文件管理、端口扫描、提权、获取信息等功能。拥有较为完善功能的webshell称之为大马。功能简单的webshell称为小马



## 上传检测流程

- 1.前端提交
  - JavaScript检测
  - Flash AS检测
- 2.数据传输
  - WAF拦截
  - IPS拦截
- 服务端处理
  - 扩展名检测
  - MIME TYPE检测（文件参数中的content-type）
  - 文件格式检测
  - 内容检测（同WAF/IDS）
- 写入文件系统
  - 文件重命名
  - 杀毒软件查杀
- 访问文件
  - 无执行权限
  - 未知位置

## 客户端检测绕过

- 1.JavaScript检测：通过浏览器提交上传请求前，出发检测用JS脚本进行检测，如普通表单上传
- 2.Flash AS脚本检测：上传用Flash中，提交上传请求前，触发检测用AS脚本进行检测
- 3.APP上传检测：检测写在APP客户端代码中，或者所调用的HTML页面中



- 客户端检测一般只检测文件扩展名
- 客户端进行的检测可通过对客户端代码的修改或拦截请求修改报文即可绕过

### 前端JavaScript检测绕过

- 1.查看onchange、onsubmit等事件
  - onchange事件会在域的内容改变时发生
  - onsubmit事件会在表单的确认按钮被点击时发生，如下图示例
- 2.删掉相关事件中的检测函数

## 提交报文修改检测绕过

- 1.先选择正常的文件进行上传
- 2.然后对上传文件的包进行截获，修改，重新上传
- 这种方法可以绕过前端检测

## 服务端检测绕过

- 服务端监测点
  - 1.文件扩展名
  - 2.MIME/TYPE类型，该参数是由浏览器自动生成的，根据上传时选择的文件的扩展名进行mime/type的选择
  - 3.文件内容

### MIME类型检测绕过

MIME(Multipurpose Interent Mail Extensions)是描述消息内容类型的因特网标准

MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据

浏览器会自动根据上传的文件扩展名，对应到相应的MIME类型上

- 常见的MIME TYPE白名单

| 扩展名 | MIME TYPE          |
| ------ | ------------------ |
| jpg    | image/jpeg         |
| png    | image/png          |
| txt    | text/plain         |
| zip    | application/zip    |
| doc    | application/msword |

### 文件内容检测绕过

- 1.简单文件头检测

  文件头是位于文件开头的一段承担一定任务的数据，一般都在开头部分

  文件头的其实部分中一般开头标记文件类型

  如GIF的文件头为GIF89a或GIF87a

- 绕过：这种只对文件头部进行简单匹配的方法，可以通过在上传的文件前追加合法的文件头进行绕过

  如：`GIF89a<?php phpinfo();?>`

- 2.完整文件结构检测

  通过调用图像函数（如getimagesize/imagecreatefromgif/imagecreatefrompng），进行文件检测是否为图像，需要文件内容保持相对完整，所以无法通过上面追加头部起始字节的方法进行绕过

- 绕过

  这种检测可以将图片文件与欲上传文件进行合并来绕过检测

  先搞一个小的图片文件，然后使用copy命令把要上传的非法文件进行合并，然后上传，就可以绕过完整文件检测了

- 3.恶意文件内容检测

  检测提交的文件中是否包含webshell等数据

## 文件上传小技巧

- 1.文件参数多为filename属性

  文件上传过程中，如果存在waf拦截一些扩展名，可以通过尝试多个filename属性

- 2.目录可控时，可以尝试使用目录穿越的方法（../）

  目录可控：程序在指定路径下的指定后缀的文件禁止访问，这种情况下如果非法程序上传成功了，但是也无法执行的

  此时需要抓包，将filename属性添加上../，意思是上传到指定目录的上一级，这样访问上一级就能绕过该方式的控制了

## 解析漏洞

- 1.IIS/Nginx+PHP fastcgi取值错误解析漏洞（配置错误）

  开启了cgi.fix_pathinfo，如果开启后，执行文件不存在，会继续查找上一级文件是否存在，

## 绕过技巧

### 重绘图

- 应用调用图片库对上传的文件进行了图像转换，所以即使将图片与文件合并，也会将尾部转换掉，无法使用前面的方法进行文件上传
- 解决方法：
  - 1.将正常图片用目标使用的图形库进行转换
  - 2.寻找转换前后两次未变的部分
  - 3.将未变部分替换为欲上传的webshell
  - 4.将替换后的文件进行图像转换，看是否转换后仍存在替换后部分
