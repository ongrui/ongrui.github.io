# TCP


## 简介

- TCP(Transmission Control Protocol)传输控制协议，是一种面向连接的、可靠的、基于字节流的传输层通信协议
  - 面向连接：点对点的连接
  - 字节流：是指传输过程中，传输数据的最基本单位是字节的流，一个不包含边界数据的连续流
  - 流：流是一个抽象的概念，是对输入输出的抽象，输入流可以看作一个输入通道，输出流可以看作一个输出通道。外部传入数据给程序需要借助输入流。程序传输到外部需要借助输出流

- TCP是传输层的协议
- TCP连接是全双工的，并且是点到点的。TCP不支持组播和广播的传输模式
- 一个TCP连接使用源地址、源端口、目的地址、目的端口四元组来确定（源地址和目标地址在IP层写入）

## TCP头部格式

- 1.源端口号：自己的端口号
- 2.目标端口号：对方的端口号
- 3.序列号：在建立连接时由计算机生成的随机数作为其初始值，每交换一次数据，该值就会+1被放到确认应答号中，用来解决包乱序
- 4.确认应答号：发送端收到这个确认应答号后，会认为在这之前的数据都已经被正常接收。用来解决不丢包
- 5.首部长度：该字段指明了TCP头包含多少个32位的字。这个信息是必须的，因为选项字段是可变长的，因而整个头也是变长的
- 6.8个1比特的标志位
  - CWR：当收到了接收端的ECE信号时，发送端将CWR标志位设置为1，发送给接收端，这样接收端就知道了发送端放慢了发送速度
  - ECE：当TCP端收到了网络拥塞的指示后，就设置ECE给TCP发送端发ECN-Echo信号，告诉发送端放慢发送速率
  - URG：该位为1时，表示此数据包需要立即发送，无需考虑发送顺序问题
  - ACK：表示确认应答
  - PSH：与URG相对应，让接收端首先接收这条数据
  - RST：表示出现异常并必须强制断开连接
  - SYN：只有建立连接请求和确认请求的两个数据包中的SYN为1（三次握手的第一二次握手）
  - FIN：表示该连接要被释放，发送端已经没有数据要传输了。
- 7.窗口大小：用于TCP流量控制，该字段指定了从被确认的字节算起可以发送多少个字节，该字段值可以为0
- 8.校验和：
- 9.紧急指针
- 10.选项（0或32位的倍数）：提供了一种添加额外数据的字段，主要针对常规头覆盖不到的方面。协议定义了许多选项，选项的长度可变长，但必须是32位的倍数，不足32位用0填充。选项有40个字节的空间
- 11.数据

## 建立连接

TCP是面向连接的协议，建立连接是通过三次握手进行的

### 三次握手

<img src="https://z3.ax1x.com/2021/07/27/W4vVwq.png" width="50%">

#### 第一次握手

服务端执行listen原语

- 1.客户端执行connect原语
- 2.初始化一个序列号，放到TCP首部的序号字段中
- 3.把SYN标志位置为1，向服务端发起连接，该报文不包含应用层之间的数据

之后客户端处于SYN-SENT状态

<img src="https://z3.ax1x.com/2021/07/27/W4L4df.png" width="60%">

#### 第二次握手

- 1.当第一次握手的数据段到达服务端后，服务器的TCP实体会先检查首部的目的端口号是否被进程监听，如果没有则返回一个RET标志位位1的报文，拒绝连接。如果有进程监听，则进入第二步，交给监听该端口的进程处理

- 2.服务端收到客户端的SYN报文后，会随机初始化自己的序号，然后将序号写入TCP首部的序号字段中
- 3.将TCP首部的序列号字段+1，写入确认应答号中
- 4.将SYN和ACK标志位置为1
- 5.将该报文发送给客户端
- 6.之后服务端置于SYN-RCVD状态

<img src = "https://z3.ax1x.com/2021/07/27/W4XHrn.png" width="60%">

#### 第三次握手

- 1.将TCP首部ACK标志位置为1
- 2.将序列号+1写入确认应答号中
- 3.将报文发送给服务端
- 4.置于ESTABLISHED（确认连接）状态

<img src = "https://z3.ax1x.com/2021/07/27/W4jtzQ.png" width="60%">

## 连接释放

### 四次挥手

<img src = "https://z3.ax1x.com/2021/07/27/W5MdX9.png" width="50%">

如客户端想要断开连接

- 1.**客户端**向服务端发送一个TCP首部**FIN标志位为1**的报文，请求断开链接，之后客户端进入**fin_wait_1**状态
- 2.**服务端**收到报文后向客户端发送**ACK标志位为1**的报文，然后进入**fin_wait_2**状态
- 3.**服务端**处理完数据后，也向客户端发送一个**FIN标志位为1**的报文，之后进入**last_ack**状态
- 4.**客户端**收到服务端发送的FIN报文后，向服务端回复一个**ACK标志位为1**的报文，然后进入**time_wait**状态

服务端收到ack报文后，立即进入close状态

之后客户端在经过2msl的等待之后自动进入close状态

**每一方都需要发送一个FIN和ACK报文**

## UDP

User Datagram Protocol 用户数据报协议，和TCP一样，位于OSI模型的传输层

UDP是无连接的，不可靠的数据报协议

- 数据报：面向无连接的数据传输，工作过程类似于报文交换。采用数据报方式传输时，被传输的分组称为数据报

### UDP头部格式

<img src = "https://z3.ax1x.com/2021/07/28/WoTIaT.png" width="70%">

- 源端口：源端口号，在需要对方回信时候写入，不需要则为0
- 目标端口：目的端口
- 包长度：保存了UDP首部的长度和数据长度之和
- 校验和：校验和是为了提供可靠的UDP首部和数据，检测UDP用户数据报在传输中是否有错。有错就丢弃。

### TCP和UDP的区别

1.连接：

- TCP：面向连接的传输层协议，传输数据首先要建立连接
- UDP：无连接的协议，不用建立连接，直接发送数据

2.服务对象

- TCP：一对一的服务
- UDP：可以一对一、一对多、多对多

3.可靠性

- TCP：会保证数据无差错、不丢失、不重复、按需到达
- UDP：不保证数据的完整性

4.流量控制

- TCP：有流量控制和拥塞控制机制，保证数据传输的安全性
- UDP：没有流量控制机制，无论网络环境如何，照常发送数据



## 学习资料

https://github.com/QSCTech/zju-icicles/blob/master/计算机网络基础/教材/计算机网络 第5版.pdf

https://mp.weixin.qq.com/s/rX3A_FA19n4pI9HicIEsXg

https://zh.wikipedia.org/wiki/用户数据报协议

https://wiki.mbalib.com/wiki/%E6%95%B0%E6%8D%AE%E6%8A%A5

